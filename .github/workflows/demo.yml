name: Demo

on:
  workflow_dispatch:
  push:

jobs:
  demo:
    name: Docker Compose demo
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install AWS CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip3 install --upgrade --user awscli
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Start stack
        run: docker compose up --build -d

      - name: Wait for API health
        shell: bash
        run: |
          set -euo pipefail
          for i in {1..60}; do
            body="$(curl -s http://localhost:8080/actuator/health || true)"
            if echo "$body" | grep -q '"status":"UP"'; then
              echo "API is healthy"
              exit 0
            fi
            echo "Waiting for API health endpoint"
            sleep 2
          done
          echo "API did not become healthy in time"
          exit 1

      - name: Publish test events
        shell: bash
        run: |
          set -euo pipefail
          for i in {1..100}; do
            printf '{"id":"evt-%03d","type":"user.created","payload":"{\"userId\":\"%03d\"}"}\n' "$i" "$i"
          done | curl -N --no-buffer -X POST http://localhost:8080/events/stream \
            -H "Content-Type: application/x-ndjson" \
            -H "x-ack-mode: wait" \
            --data-binary @-

      - name: Dump stack logs on failure
        if: failure()
        run: |
          docker compose ps
          docker compose logs --no-color api
          docker compose logs --no-color s3-sink
          docker compose logs --no-color kafka
          docker compose logs --no-color localstack

      - name: Verify Parquet output in LocalStack
        shell: bash
        env:
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test
          AWS_DEFAULT_REGION: us-east-1
        run: |
          set -euo pipefail
          aws --endpoint-url=http://localhost:4566 s3 ls s3://demo-parquet-bucket/events/
          topic_prefix="$(aws --endpoint-url=http://localhost:4566 s3 ls s3://demo-parquet-bucket/events/ | awk '/PRE topic=/{print $2}' | head -n1)"
          if [ -z "$topic_prefix" ]; then
            echo "No topic prefix found in bucket"
            exit 1
          fi
          aws --endpoint-url=http://localhost:4566 s3 ls "s3://demo-parquet-bucket/events/${topic_prefix}"
          date_prefix="$(aws --endpoint-url=http://localhost:4566 s3 ls "s3://demo-parquet-bucket/events/${topic_prefix}" | awk '/PRE date=/{print $2}' | head -n1)"
          if [ -z "$date_prefix" ]; then
            echo "No date prefix found for ${topic_prefix}"
            exit 1
          fi
          aws --endpoint-url=http://localhost:4566 s3 ls "s3://demo-parquet-bucket/events/${topic_prefix}${date_prefix}"

      - name: Tear down stack
        if: always()
        run: docker compose down -v
